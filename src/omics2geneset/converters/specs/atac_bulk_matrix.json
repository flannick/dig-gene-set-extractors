{
  "name": "atac_bulk_matrix",
  "description": "Bulk ATAC peak-by-sample matrix differential converter producing OPEN/CLOSE gene programs",
  "inputs": [
    {"name": "peak_matrix_tsv", "type": "tsv", "description": "Peak-by-sample matrix with one row per peak and one numeric column per sample", "required": true},
    {"name": "peak_bed", "type": "bed", "description": "Peak coordinates aligned row-wise with peak_matrix_tsv", "required": true},
    {"name": "sample_metadata_tsv", "type": "tsv", "description": "Sample metadata table containing sample_id and condition columns", "required": true},
    {"name": "gtf", "type": "gtf", "description": "Gene annotation with gene features", "required": true}
  ],
  "parameters": [
    {"name": "dataset_label", "type": "string_or_none", "default": null, "help": "Optional dataset label included in GMT names and metadata"},
    {"name": "sample_id_column", "type": "string", "default": "sample_id", "help": "Column in sample_metadata_tsv containing sample identifiers matching matrix sample columns"},
    {"name": "condition_column", "type": "string", "default": "condition", "help": "Condition column in sample_metadata_tsv"},
    {"name": "condition_a", "type": "string_or_none", "default": null, "help": "Condition A label; if omitted and exactly two levels exist it is inferred"},
    {"name": "condition_b", "type": "string_or_none", "default": null, "help": "Condition B label; if omitted and exactly two levels exist it is inferred"},
    {"name": "contrast_metric", "type": "string", "default": "log2fc", "enum": ["log2fc", "diff"], "help": "Per-peak differential statistic between condition A and B"},
    {"name": "contrast_pseudocount", "type": "float", "default": 1.0, "help": "Pseudocount used when contrast_metric=log2fc"},
    {"name": "link_method", "type": "string", "default": "all", "help": "Comma-separated linking tokens: all,promoter_overlap,nearest_tss,distance_decay,external"},
    {"name": "region_gene_links_tsv", "type": "tsv_optional", "default": null, "help": "Required when link_method includes external; columns chrom,start,end,gene_id,link_weight"},
    {"name": "promoter_upstream_bp", "type": "int", "default": 2000, "help": "Promoter upstream window for promoter_overlap"},
    {"name": "promoter_downstream_bp", "type": "int", "default": 500, "help": "Promoter downstream window for promoter_overlap"},
    {"name": "max_distance_bp", "type": "int_or_none", "default": null, "help": "Distance cap for nearest/distance modes; resolved default by link_method"},
    {"name": "decay_length_bp", "type": "int", "default": 50000, "help": "Exponential decay length for distance_decay"},
    {"name": "max_genes_per_peak", "type": "int", "default": 5, "help": "Maximum linked genes per peak for distance_decay"},
    {"name": "peak_weight_transform", "type": "string", "default": "positive", "enum": ["signed", "abs", "positive", "negative"], "help": "Direction selected for geneset.tsv (positive=OPEN, negative=CLOSE)"},
    {"name": "program_preset", "type": "string", "default": "connectable", "enum": ["none", "default", "connectable", "all"], "help": "ATAC program family preset for additional GMT programs"},
    {"name": "program_methods", "type": "string_csv_optional", "default": null, "help": "Optional explicit ATAC program methods overriding preset"},
    {"name": "resources_manifest", "type": "string_or_none", "default": null, "help": "Optional resources manifest path"},
    {"name": "resources_dir", "type": "string_or_none", "default": null, "help": "Optional resources cache directory"},
    {"name": "resource_policy", "type": "string", "default": "skip", "enum": ["skip", "fail"], "help": "Behavior when a requested resource-backed method cannot load its resource"},
    {"name": "ref_ubiquity_resource_id", "type": "string_or_none", "default": null, "help": "Resource id for ref_ubiquity_penalty (default depends on genome_build)"},
    {"name": "atlas_resource_id", "type": "string_or_none", "default": null, "help": "Resource id for atlas_residual (default depends on genome_build)"},
    {"name": "atlas_metric", "type": "string", "default": "logratio", "enum": ["logratio", "zscore"], "help": "Metric used by atlas_residual"},
    {"name": "atlas_eps", "type": "float", "default": 1e-6, "help": "Stability epsilon for atlas_residual formulas"},
    {"name": "select", "type": "string", "default": "top_k", "enum": ["none", "top_k", "quantile", "threshold"], "help": "Method for selecting the compact output gene program"},
    {"name": "top_k", "type": "int", "default": 200, "help": "Number of genes kept when select=top_k"},
    {"name": "quantile", "type": "float", "default": 0.01, "help": "Top fraction kept when select=quantile"},
    {"name": "min_score", "type": "float", "default": 0.0, "help": "Score threshold when select=threshold"},
    {"name": "emit_full", "type": "bool", "default": true, "help": "If true, also write geneset.full.tsv with all nonzero scores"},
    {"name": "normalize", "type": "string", "default": "within_set_l1", "enum": ["none", "l1", "within_set_l1"], "help": "Weight normalization mode"},
    {"name": "emit_gmt", "type": "bool", "default": true, "help": "If true, write program gene sets in GMT format"},
    {"name": "gmt_out", "type": "string_or_none", "default": null, "help": "Output GMT path relative to out_dir (or absolute path)"},
    {"name": "gmt_prefer_symbol", "type": "bool", "default": true, "help": "Prefer gene_symbol over gene_id when writing GMT tokens"},
    {"name": "gmt_require_symbol", "type": "bool", "default": true, "help": "Require non-Ensembl-like gene symbols for GMT tokens; drop unmapped entries"},
    {"name": "gmt_biotype_allowlist", "type": "string_csv", "default": "protein_coding", "help": "Comma-separated allowed gene biotypes from GTF; empty string disables filter"},
    {"name": "gmt_min_genes", "type": "int", "default": 100, "help": "Minimum genes per emitted GMT set"},
    {"name": "gmt_max_genes", "type": "int", "default": 500, "help": "Maximum genes per emitted GMT set"},
    {"name": "gmt_topk_list", "type": "string_csv_ints", "default": "100,200,500", "help": "Comma-separated top-K plans for GMT emission"},
    {"name": "gmt_mass_list", "type": "string_csv_floats", "default": "0.5,0.8,0.9", "help": "Comma-separated HPD mass thresholds for GMT emission"},
    {"name": "gmt_split_signed", "type": "bool", "default": false, "help": "Split signed scores into positive/negative GMT plans when negatives are present"}
  ],
  "outputs": [
    {"name": "geneset.tsv", "description": "Selected compact OPEN/CLOSE program depending on peak_weight_transform"},
    {"name": "geneset.full.tsv", "description": "Optional full score table for selected direction"},
    {"name": "genesets.gmt", "description": "OPEN and CLOSE GMT gene sets across program families"},
    {"name": "geneset.meta.json", "description": "Run metadata and provenance validated against schema"}
  ]
}
